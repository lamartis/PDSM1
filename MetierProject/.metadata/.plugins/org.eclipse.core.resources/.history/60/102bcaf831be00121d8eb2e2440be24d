package fr.projet26.producteur;

import java.io.InputStream;
import java.util.Properties;
import java.util.logging.FileHandler;
import java.util.logging.Logger;

import javax.jms.*;
import org.apache.activemq.ActiveMQConnectionFactory;
import fr.projet26.interfaces.JMSProducer;

public class Producer implements JMSProducer {
	Properties property = new Properties();
	InputStream fis = this.getClass().getClassLoader().getResourceAsStream("config.properties");
	String subject;
	ConnectionFactory connectionFactory;
	MessageProducer producer;
	Connection connection;
	Session session;
	String message;
	static final Logger logger = Logger.getLogger(Producer.class.getName());

	public Producer(String subject){
		try{
			logger.addHandler(new FileHandler("metier.log"));
			
			property.load(fis);
			connectionFactory = new ActiveMQConnectionFactory(property.getProperty("url"));
			this.subject = subject;
			connection = connectionFactory.createConnection();
			connection.start();
			session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
			Destination destination = session.createQueue(subject);
			producer = session.createProducer(destination);

			logger.info("Initialized Producer: [" + subject + "]");
			//System.out.println("Initialized Producer: [" + subject + "]");
			//Faut créer un singleton logger, dans le métier, et le mettre dans MyContextListener, et le récuperer dans TraitementI et TraitementP
		}catch(Exception e){
			System.out.println(e.getMessage());
		}
	}

	public synchronized void setMessage(String m){
		this.message = m;
	}
	
	public Void call() throws Exception{
		try{
			TextMessage message = session.createTextMessage(this.message);
			producer.send(message);
			logger.info(message.getText());
		}catch(Exception e){
			System.out.println(e.getMessage());
		}
		return null;
	}

	public void closeConnection(){
		try{
			connection.close();
		}catch(Exception e){
			System.out.println(e.getMessage());
		}
	}

}